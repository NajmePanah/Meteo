@inject IHttpContextAccessor httpContextAccessor

@{
	bool isFront = ViewData["isFront"] is bool isFrontValue && isFrontValue;
	string frontPrefix = isFront ? "front-" : "";
	string frontVar = isFront ? "Front" : "";
	string containerClass = ViewData["container"] as string ?? "";
	string contentTypeClass = containerClass == "container-xxl" ? "layout-compact" : "layout-wide";
	ViewData["main"] = frontPrefix;
	ViewData["frontVar"] = frontVar;
	ViewData["contentType"] = contentTypeClass;

	string pageTitle = ViewData["title"] as string ?? "";
	string productPage = TempData.Peek("productPage") as string ?? "";
	bool isHorizontalMenu = Convert.ToBoolean(TempData.Peek("menuHorizontal")?.ToString());
	string templateType = isFront ? "front-page" : (isHorizontalMenu ? "horizontal-menu-template" : "vertical-menu-template");

	string assetPath = $"{httpContextAccessor.HttpContext?.Request.PathBase}/";
}

<!DOCTYPE html>
<html lang="en"
	  class="light-style @(ViewData["navbarType"] ?? "") @(ViewData["menuFixed"] ?? "") @(ViewData["menuCollapsed"] ?? "") @(ViewData["contentType"] ?? "") @(ViewData["footerFixed"] ?? "") @(ViewData["customizerHidden"] ?? "")"
	  dir="ltr"
	  data-theme="theme-default"
	  data-assets-path="@assetPath"
	  data-template="@templateType">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
	<title>@pageTitle | پرتال اداره کل</title>
	<meta name="description" content="" />
	<link rel="canonical" href="@productPage" />
	<link rel="icon" type="image/x-icon" href="~/img/favicon/favicon.ico" />

	@await Html.PartialAsync($"Sections/_Styles{frontVar}")
	@RenderSection("VendorStyles", required: false)
	@RenderSection("PageStyles", required: false)
	@await Html.PartialAsync($"Sections/_ScriptsIncludes{frontVar}")

	<style>
		#template-customizer {
			display: none;
		}
	</style>
</head>

<body>
	@RenderBody()

	@await Html.PartialAsync($"Sections/_Scripts{frontVar}")
	@RenderSection("VendorScripts", required: false)
	<script src="~/js/@(frontPrefix)main.js"></script>
	@RenderSection("PageScripts", required: false)
	@RenderSection("ModulePageScripts", required: false)

	<script>
		$(window).on("pageshow", function (event) {
			if (event.originalEvent.persisted) {
				$(".content-loader").fadeOut(300);
			}
		});

		$(document).on("click", ".need-loader", function () {
			$(".content-loader").fadeIn(300);
		});
	</script>

	@if (User != null && User.Identity != null && User.Identity.IsAuthenticated)
	{
		<script src="~/vendor/libs/signalr/signalr.min.js"></script>
		<script>
			function createNotificationHtml(notification) {
				return `
					<li class="list-group-item list-group-item-action dropdown-notifications-item waves-effect">
						<a class="d-flex" href="${notification.path || '#'}">
							<div class="flex-shrink-0 me-3">
								<div class="avatar avatar-online" data-user-avatar="administrator">
									<img src="/img/avatars/administrator.png" alt="فاقد نام" title="فاقد نام" class="rounded-circle">
								</div>
							</div>
							<div class="flex-grow-1">
								<h6 class="mb-1 small">${notification.title}</h6>
								<small class="mb-1 d-block text-body">${notification.message}</small>
								<small class="text-muted">لحظاتی قبل</small>
							</div>
						</a>
						<div class="flex-shrink-0 dropdown-notifications-actions">
							<a class="dropdown-notifications-archive" href="/Notification/Delete/${notification.id}">
								<span class="ti ti-x"></span>
							</a>
						</div>
					</li>
				`;
			}
			function shouldShowNotification(notification) {
				const id = notification.id || notification.title;
				const lockKey = `notif-lock-${id}`;
				const now = Date.now();
				const lockTimeout = 5000; // 5 ثانیه

				try {
					const existingLock = localStorage.getItem(lockKey);
					if (existingLock && now - parseInt(existingLock) < lockTimeout) {
						return false;
					}

					// ست کردن قفل
					localStorage.setItem(lockKey, now.toString());

					// فقط در صورت ماندگار بودن قفل، نمایش بده
					setTimeout(() => {
						const checkLock = localStorage.getItem(lockKey);
						if (checkLock === now.toString()) {
							showBrowserNotification(notification);
						}
					}, 50);

					return false;

				} catch (err) {
					console.warn("⚠️ LocalStorage Lock Error:", err);
					return true;
				}
			}

			function showBrowserNotification(notification) {
				if ('Notification' in window && Notification.permission === "granted") {
					const browserNotification = new Notification(notification.title, {
						body: notification.message,
						icon: "/img/favicon/favicon-32x32.png"
					});

					if (notification.path) {
						browserNotification.onclick = function (event) {
							event.preventDefault();
							const win = window.open("/Notification/View/"+notification.id, "_blank");
							if (!win) {
								alert("مرورگر شما باز کردن صفحه جدید را مسدود کرده است. لطفاً تنظیمات پاپ‌آپ را بررسی کنید.");
							}
						};
					}
				} else {
					alert(`${notification.title}\n${notification.message}`);
				}
			}

			const notificationConnection = new signalR.HubConnectionBuilder()
				.withUrl("/notificationHub")
				.build();

			notificationConnection.on("ReceiveNotification", function (notification) {
				console.log("📩 Notification received:", notification);

				if (!shouldShowNotification(notification)) {
					console.log("⛔ Duplicate notification ignored (or delayed).");
					return;
				}
				const html = createNotificationHtml(notification);
				const ul = document.querySelector(".dropdown-notifications-list ul");
				if (ul) {
					ul.insertAdjacentHTML("afterbegin", html); // ناتیف جدید بالای لیست قرار بگیره
				}
			});

			notificationConnection.start().catch(function (err) {
				return console.error(err.toString());
			});

			$(document).ready(function () {
				if ('Notification' in window &&
					Notification.permission !== 'granted' &&
					Notification.permission !== 'denied' &&
					!localStorage.getItem("notificationPrompted")) {

					$('#notificationModal').modal('show');
				}

				$('#allow-push-notification').on('click', function () {
					Notification.requestPermission().then(function (status) {
						localStorage.setItem("notificationPrompted", "true");

						if (status === 'granted') {
							new Notification("اعلان فعال شد", {
								body: "شما با موفقیت اجازه دریافت اعلان را صادر کردید.",
								icon: "/img/favicon/favicon-32x32.png"
							});
						}

						$('#notificationModal').modal('hide');
					});
				});

				$('#close-push-notification').on('click', function () {
					localStorage.setItem("notificationPrompted", "true");
					$('#notificationModal').modal('hide');
				});
			});
		</script>

		<script>
			const presenceConnection = new signalR.HubConnectionBuilder()
				.withUrl("/presenceHub")
				.build();

			presenceConnection.on("UserStatusChanged", function (username, isOnline) {
				$("[data-user-avatar='" + username + "']").each(function () {
					$(this).addClass(isOnline ? "avatar-online" : "avatar-offline");
					$(this).removeClass(isOnline ? "avatar-offline" : "avatar-online");
				});
			});

			presenceConnection.start()
				.then(function () {
					return presenceConnection.invoke("GetOnlineUsers");
				})
				.then(function (onlineUsers) {
					$("[data-user-avatar]").each(function () {
						const username = $(this).data("user-avatar");
						const isOnline = onlineUsers.includes(username);

						$(this).addClass(isOnline ? "avatar-online" : "avatar-offline");
						$(this).removeClass(isOnline ? "avatar-offline" : "avatar-online");
					});
				})
				.catch(function (err) {
					console.error("خطا در اتصال یا دریافت کاربران آنلاین:", err.toString());
				});
		</script>
		<!-- Push Notification Modal -->
		<div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modal-sm" role="document">
				<div class="modal-content text-center">
					<div class="modal-header">
						<h4 class="modal-title">پیغام</h4>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
					</div>
					<div class="modal-body">
						<h5>آیا مایل به دریافت پیام‌های سامانه هستید؟</h5>
						<small class="text-muted">در صورت تایید اخطار های مربوط به سامانه را در لحظه دریافت خواهید کرد</small>
					</div>
					<div class="modal-footer d-flex justify-content-center">
						<button type="button" class="btn btn-primary" id="allow-push-notification">
							<i class="ti ti-check me-2"></i>بله
						</button>
						<button type="button" class="btn btn-danger" id="close-push-notification">
							<i class="ti ti-ban me-2"></i>خیر
						</button>
					</div>
				</div>
			</div>
		</div>
		<span class="chat-bubble p-6 text-primary disabled"
				type="button"
				data-bs-toggle="offcanvas"
				data-bs-target="#offcanvasBoth"
				aria-controls="offcanvasBoth">
			<i class="ti ti-message text-muted"></i>
		</span>
		<div class="offcanvas offcanvas-end chat-canvas"
			 data-bs-scroll="true"
			 tabindex="-1"
			 id="offcanvasBoth"
			 aria-labelledby="offcanvasBothLabel">
			<div class="offcanvas-header d-flex justify-content-between">
				<h5 id="offcanvasBothLabel" class="offcanvas-title">گفتگوی آنلاین</h5>
				<button type="button"
						class="btn-close text-reset me-0"
						data-bs-dismiss="offcanvas"
						aria-label="Close"></button>
			</div>
			<div class="offcanvas-body my-auto mx-0 flex-grow-0">

			</div>
		</div>
	}
</body>
</html>
